{% extends 'base.html' %}
{% load auth_extras %}

{% block title %}Blog{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Blog</h2>
  <div>
    {% if user|has_group:"Manager" %}
    <a href="{% url 'blog:blog-post-add' %}" class="btn btn-primary me-2">Add New Post</a>
    {% endif %}
    <form id="category-filter-form" method="get" class="d-inline-block">
      <select id="category-select" name="category" class="form-select">
        <option value="">All Categories</option>
        {% for category in categories %}
        <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
        {% endfor %}
      </select>
    </form>
  </div>
</div>
<div id="blog-posts-container" class="row">
  {% for post in blog_posts %}
  {% include 'blog/includes/blogpost_card.html' with post=post %}
  {% empty %}
  <p>No blog posts yet.</p>
  {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.getElementById('category-select').addEventListener('change', function (e) {
    const categoryId = e.target.value;
    const url = `{% url 'blog:api-blog-post-list' %}?category=${categoryId}`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const container = document.getElementById('blog-posts-container');
        container.innerHTML = ''; // Clear existing posts

        if (data.length > 0) {
          data.forEach(html_card => {
            container.innerHTML += html_card;
          });
        } else {
          container.innerHTML = '<p>No blog posts in this category.</p>';
        }
      });
  });
</script>
{% endblock %}